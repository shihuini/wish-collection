<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心愿收集小程序（最终修复版）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#E879F9',
                        secondary: '#8B5CF6',
                        accent: '#F472B6',
                        light: '#FDF4FF',
                        dark: '#6D28D9'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'sparkle': 'sparkle 2s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        sparkle: {
                            '0%, 100%': { opacity: 1, transform: 'scale(1)' },
                            '50%': { opacity: 0.7, transform: 'scale(0.95)' },
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .text-shadow-lg {
                text-shadow: 0 4px 8px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.08);
            }
            .bg-glass {
                background: rgba(255,255,255,0.7);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            .btn-3d {
                @apply relative px-8 py-3 rounded-xl font-bold transform transition-all duration-150 overflow-hidden;
                box-shadow: 0 4px 0 0 rgba(0,0,0,0.2);
            }
            .btn-3d:active {
                @apply translate-y-1;
                box-shadow: 0 2px 0 0 rgba(0,0,0,0.2);
            }
            .btn-3d-primary {
                @apply bg-gradient-to-b from-primary to-secondary text-white;
                box-shadow: 0 4px 0 0 #9333EA;
            }
            .card-wish {
                @apply relative bg-white rounded-2xl shadow-xl overflow-hidden;
            }
            .card-wish::before {
                content: '';
                @apply absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-primary via-accent to-secondary;
            }
            .reflection {
                @apply absolute top-0 left-0 right-0 h-1/3 bg-gradient-to-b from-white/30 to-transparent z-0;
            }
            .step-content {
                @apply transition-all duration-300 ease-in-out;
            }
            .step-content.active {
                @apply opacity-100;
            }
            .step-content.hidden {
                @apply opacity-0 absolute;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-cover bg-center flex items-center justify-center p-4" style="background-image: url('https://p11-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/4cff099cda9a42ed8588b3c9d5ff3836~tplv-a9rns2rl98-image.image?lk3s=8e244e95&rcl=202602101607393D2253E2CDA27E2BB4A1&rrcfp=f06b921b&x-expires=1773302894&x-signature=JDMxj7iolHcEVdggBDzLkc16ZyI%3D');">
    
    <div id="stars-container" class="fixed inset-0 pointer-events-none z-0"></div>
    
    <div class="w-full max-w-md relative z-10">
        <div class="text-center mb-8 animate-float">
            <img src="https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/69132cbdef304df7ba21d4d47865872e~tplv-a9rns2rl98-image.image?lk3s=8e244e95&rcl=202602101607393D2253E2CDA27E2BB4A1&rrcfp=f06b921b&x-expires=1773302894&x-signature=M5VpySVVl6%2FbmRcnSdYYobg9Da4%3D" alt="礼物盒" class="w-24 h-24 mx-auto mb-4 animate-sparkle">
            <h1 class="text-4xl font-bold text-white text-shadow-lg">心愿收集</h1>
            <p class="text-lg text-white/90 mt-2">每一颗星星都是一个心愿</p>
        </div>
        
        <div class="flex justify-between mb-8 px-4">
            <div class="step-indicator flex flex-col items-center" data-step="1">
                <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold mb-2 step-active">1</div>
                <span class="text-white text-sm">输入姓名</span>
            </div>
            <div class="step-indicator flex flex-col items-center" data-step="2">
                <div class="w-10 h-10 rounded-full bg-white/30 text-white flex items-center justify-center font-bold mb-2">2</div>
                <span class="text-white text-sm">查看价位</span>
            </div>
            <div class="step-indicator flex flex-col items-center" data-step="3">
                <div class="w-10 h-10 rounded-full bg-white/30 text-white flex items-center justify-center font-bold mb-2">3</div>
                <span class="text-white text-sm">提交/修改心愿</span>
            </div>
        </div>
        
        <div class="bg-glass rounded-2xl shadow-2xl p-6 mb-6">
            <div id="step-1" class="step-content active">
                <h2 class="text-2xl font-bold text-dark mb-6 text-center">请输入您的姓名</h2>
                <div class="mb-6">
                    <label for="name" class="block text-gray-700 font-medium mb-2">姓名</label>
                    <input type="text" id="name" class="w-full px-4 py-3 rounded-xl border-2 border-purple-200 focus:border-primary focus:outline-none transition-all" placeholder="请输入您的姓名" required>
                </div>
                <div class="text-center">
                    <button id="check-name-btn" class="btn-3d btn-3d-primary w-full">
                        <span class="relative z-10">进入我的心愿清单</span>
                        <div class="reflection"></div>
                    </button>
                </div>
            </div>
            
            <div id="step-2" class="step-content hidden">
                <h2 class="text-2xl font-bold text-dark mb-6 text-center">您的心愿价位</h2>
                <div class="bg-light rounded-xl p-6 mb-6 text-center">
                    <div class="text-4xl font-bold text-primary mb-2" id="price-amount">¥200</div>
                    <p class="text-gray-600">您可以选择不超过此价位的心愿奖品</p>
                </div>
                
                <div id="existing-wish-card" class="card-wish p-4 mb-6 hidden">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="text-lg font-bold text-dark">您已提交的心愿</h4>
                        <span class="text-xs text-gray-500" id="existing-wish-time"></span>
                    </div>
                    <div class="bg-light rounded-lg p-3 mb-3">
                        <p class="text-gray-700" id="existing-wish-content"></p>
                    </div>
                    <div class="text-center">
                        <button id="edit-wish-btn" class="btn-3d bg-blue-500 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fa fa-pencil mr-1"></i> 修改心愿
                        </button>
                    </div>
                </div>
                
                <div id="wish-input-area">
                    <div class="mb-6">
                        <label for="wish" class="block text-gray-700 font-medium mb-2">您的心愿是？</label>
                        <textarea id="wish" class="w-full px-4 py-3 rounded-xl border-2 border-purple-200 focus:border-primary focus:outline-none transition-all" rows="3" placeholder="请输入您的心愿奖品" required></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button id="back-to-step-1" class="btn-3d bg-white text-gray-700 w-1/3">
                            <span class="relative z-10"><i class="fa fa-arrow-left mr-1"></i> 返回</span>
                            <div class="reflection"></div>
                        </button>
                        <button id="submit-wish-btn" class="btn-3d btn-3d-accent w-2/3">
                            <span class="relative z-10" id="submit-btn-text">提交心愿</span>
                            <div class="reflection"></div>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="step-3" class="step-content hidden">
                <div class="text-center">
                    <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-green-100 flex items-center justify-center">
                        <i class="fa fa-check text-4xl text-green-500"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-dark mb-2" id="success-title">心愿提交成功！</h2>
                    <p class="text-gray-600 mb-6" id="success-desc">您的心愿已成功提交，让我们一起期待惊喜吧！</p>
                    
                    <div id="wish-card" class="card-wish p-6 mb-6 transform transition-all duration-500 hover:scale-105">
                        <div class="text-center mb-4">
                            <div class="inline-block p-2 rounded-full bg-primary/10">
                                <i class="fa fa-star text-2xl text-primary"></i>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold text-dark mb-2" id="wish-card-name">张三</h3>
                        <div class="bg-light rounded-lg p-4 mb-4">
                            <p class="text-gray-700" id="wish-card-content">希望能有一台新的平板电脑，用于学习和娱乐。</p>
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-500">
                            <span>价位: <span id="wish-card-price">¥200</span></span>
                            <span>提交时间: <span id="wish-card-time">2023-02-10 16:30</span></span>
                        </div>
                    </div>
                    
                    <div class="flex gap-4">
                        <button id="save-wish-btn" class="btn-3d bg-blue-500 text-white w-1/2">
                            <span class="relative z-10"><i class="fa fa-download mr-1"></i> 保存心愿卡</span>
                            <div class="reflection"></div>
                        </button>
                        <button id="back-to-wish-btn" class="btn-3d btn-3d-primary w-1/2">
                            <span class="relative z-10"><i class="fa fa-arrow-left mr-1"></i> 返回心愿页</span>
                            <div class="reflection"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center text-white/70 text-sm mb-4">
            <p>© 2026 心愿收集小程序 | 让每个心愿都有实现的可能</p>
            <p class="text-xs text-white/50 mt-1" id="deadline-tip">心愿修改截止时间：2026-02-18 23:59</p>
            <button id="admin-toggle" class="mt-2 text-xs text-white/50 hover:text-white transition-colors">管理员设置</button>
        </div>
        
        <div id="admin-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden backdrop-blur-sm">
            <div class="bg-white/5 backdrop-blur-md rounded-2xl p-8 w-full max-w-lg mx-4 border border-white/10">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-white">管理员设置</h3>
                    <button id="close-admin-modal" class="text-white/50 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg text-white/80">允许的姓名和价格</h4>
                        <button id="add-name-btn" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-primary/90 transition-colors">
                            <i class="fa fa-plus mr-1"></i> 添加
                        </button>
                    </div>
                    <div id="name-list" class="space-y-3 max-h-60 overflow-y-auto pr-2"></div>
                </div>
                
                <div class="mb-6">
                    <label for="deadline-input" class="block text-white/80 text-sm mb-2">心愿修改截止时间</label>
                    <input type="datetime-local" id="deadline-input" class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:border-primary" value="2026-02-18T23:59">
                </div>
                
                <div class="mb-6 grid grid-cols-2 gap-4">
                    <button id="view-wishes-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors">
                        <i class="fa fa-list mr-1"></i> 查看所有心愿
                    </button>
                    <button id="debug-view-data" class="bg-gray-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-600 transition-colors">
                        <i class="fa fa-bug mr-1"></i> 调试查看数据
                    </button>
                </div>
                
                <div class="flex justify-end gap-4">
                    <button id="reset-default-btn" class="bg-gray-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-600 transition-colors">
                        恢复默认
                    </button>
                    <button id="save-settings-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-600 transition-colors">
                        <i class="fa fa-save mr-1"></i> 保存设置
                    </button>
                </div>
            </div>
        </div>
        
        <div id="debug-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden backdrop-blur-sm">
            <div class="bg-white rounded-2xl p-6 w-full max-w-lg mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-dark">管理员数据调试（含价位）</h3>
                    <button id="close-debug-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <h4 class="font-bold mb-2">1. 云端心愿列表（含价位）：</h4>
                    <pre id="debug-cloud-wish" class="bg-gray-100 p-3 rounded-lg text-sm"></pre>
                </div>
                <div class="mb-4">
                    <h4 class="font-bold mb-2">2. 本地心愿列表（含价位）：</h4>
                    <pre id="debug-local-wish" class="bg-gray-100 p-3 rounded-lg text-sm"></pre>
                </div>
                <div class="mb-4">
                    <h4 class="font-bold mb-2">3. 允许的姓名价位列表：</h4>
                    <pre id="debug-name-price" class="bg-gray-100 p-3 rounded-lg text-sm"></pre>
                </div>
                <div class="text-center">
                    <button id="clear-all-data" class="btn-3d bg-red-500 text-white px-4 py-2 rounded-lg">
                        <i class="fa fa-trash mr-1"></i> 清空所有数据
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            generateStars();
            const steps = document.querySelectorAll('.step-content');
            const stepIndicators = document.querySelectorAll('.step-indicator');
            
            // 默认配置
            const DEFAULT_NAME_PRICE_MAP = {
               '石慧旎': 400,
                '李剡钗': 400,
                '李春燕': 300,
                '周雯': 400,
                '黄季虹': 400,  
                '柴文婧': 400, 
               '张雅红': 400,   
               '钱莉莉': 100,
               '苏丽梅': 400, 
                '詹若风': 400
            };
            const DEFAULT_DEADLINE = '2026-02-18T23:59';
            
            // ========== 免费云端配置（GitHub Gist） ==========
            // 替换成你的Gist信息
            const GIST_ID = "765c2c814b75155d8584c177a8ff03b6";
            const GITHUB_TOKEN = "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";
            const GIST_API_URL = `https://api.github.com/gists/${GIST_ID}`;
            
            // 关键变量
            let selectedUserName = localStorage.getItem('selectedUserName') || null;
            let currentUserWish = null;
            let isEditing = false;
            
            // 安全读写本地存储
            function safeGetStorage(key, defaultValue) {
                try {
                    const value = localStorage.getItem(key);
                    return value ? JSON.parse(value) : defaultValue;
                } catch (e) {
                    localStorage.removeItem(key);
                    return defaultValue;
                }
            }
            
            function safeSetStorage(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    alert('本地存储失败！请检查浏览器权限');
                    return false;
                }
            }
            
            // 初始化数据
            let namePriceMap = safeGetStorage('namePriceMap', DEFAULT_NAME_PRICE_MAP);
            let submittedWishes = safeGetStorage('submittedWishes', []);
            
            // 检查是否可修改心愿
            function canModifyWish() {
                const deadline = localStorage.getItem('wishDeadline') || DEFAULT_DEADLINE;
                const now = new Date();
                const deadlineDate = new Date(deadline);
                return now <= deadlineDate;
            }
            
            // ========== 修复核心：返回按钮逻辑 ==========
            // 步骤1返回按钮（修复无反应问题）
            document.getElementById('back-to-step-1').addEventListener('click', function() {
                if (confirm('确定要返回姓名输入页吗？您当前未提交的内容将丢失！')) {
                    isEditing = false;
                    document.getElementById('submit-btn-text').textContent = '提交心愿';
                    document.getElementById('wish').value = '';
                    goToStep(1);
                }
            });
            
            // 步骤3返回按钮（修复无反应问题）
            document.getElementById('back-to-wish-btn').addEventListener('click', async function() {
                await showCurrentUserWish();
                isEditing = false;
                document.getElementById('submit-btn-text').textContent = '提交心愿';
                document.getElementById('wish').value = '';
                goToStep(2);
            });
            
            // ========== 云端数据操作（GitHub Gist 免费跨设备同步） ==========
           // 获取所有云端心愿
async function getAllCloudWishes() {
    try {
        const res = await fetch(GIST_API_URL, {
            headers: {
                'Authorization': `token ${GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        // 新增：检查请求是否成功
        if (!res.ok) {
            throw new Error(`请求失败，状态码：${res.status}`);
        }
        
        const data = await res.json();
        
        // 新增：防止data/files不存在导致undefined报错
        if (!data || !data.files || !data.files['wish-collection.json']) {
            throw new Error('Gist数据格式错误或文件不存在');
        }
        
        const content = JSON.parse(data.files['wish-collection.json'].content);
        return { success: true, data: content };
    } catch (e) {
        console.error('获取云端心愿失败:', e);
        return { success: false, msg: e.message };
    }
}
            
            // 获取当前用户已提交的心愿
            async function getCurrentUserWish() {
                if (!selectedUserName) return null;
                
                // 从GitHub Gist获取
                const cloudRes = await getAllCloudWishes();
                if (cloudRes.success) {
                    const localWish = cloudRes.data.find(w => 
                        w.name.trim().toLowerCase() === selectedUserName.trim().toLowerCase()
                    );
                    return localWish;
                }
                
                // 本地兜底
                const localWish = submittedWishes.find(w => 
                    w.name.trim().toLowerCase() === selectedUserName.trim().toLowerCase()
                );
                return localWish;
            }
            
            // 提交/修改心愿到GitHub Gist
            async function submitWishToCloud(wishData) {
                try {
                    // 先获取现有数据
                    const cloudRes = await getAllCloudWishes();
                    let allWishes = cloudRes.success ? cloudRes.data : [];
                    
                    // 检查是否已存在
                    const userWishIndex = allWishes.findIndex(w => 
                        w.name.trim().toLowerCase() === wishData.name.trim().toLowerCase()
                    );
                    
                    if (userWishIndex >= 0) {
                        // 修改已有心愿
                        allWishes[userWishIndex] = wishData;
                    } else {
                        // 新增心愿
                        allWishes.push(wishData);
                    }
                    
                    // 写入Gist
                    const res = await fetch(GIST_API_URL, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            files: {
                                'wish-collection.json': {
                                    content: JSON.stringify(allWishes, null, 2)
                                }
                            }
                        })
                    });
                    
                    if (res.ok) {
                        return { success: true, msg: userWishIndex >= 0 ? '修改成功' : '提交成功' };
                    } else {
                        return { success: false, msg: 'Gist写入失败' };
                    }
                } catch (e) {
                    console.error('云端提交失败:', e);
                    return { success: false, msg: e.message };
                }
            }
            
            // ========== 原有逻辑保留 + 修复 ==========
            // 显示已提交的心愿
            async function showCurrentUserWish() {
                currentUserWish = await getCurrentUserWish();
                
                if (currentUserWish) {
                    document.getElementById('existing-wish-card').classList.remove('hidden');
                    document.getElementById('existing-wish-content').textContent = currentUserWish.content;
                    document.getElementById('existing-wish-time').textContent = currentUserWish.time;
                    
                    if (canModifyWish()) {
                        document.getElementById('edit-wish-btn').classList.remove('hidden');
                        document.getElementById('edit-wish-btn').disabled = false;
                    } else {
                        document.getElementById('edit-wish-btn').classList.add('hidden');
                        document.getElementById('edit-wish-btn').disabled = true;
                    }
                } else {
                    document.getElementById('existing-wish-card').classList.add('hidden');
                }
            }
            
            // 姓名验证逻辑
            document.getElementById('check-name-btn').addEventListener('click', async function() {
                if (selectedUserName) {
                    alert(`您已选择过姓名：${selectedUserName}，无法更换！`);
                    document.getElementById('name').value = selectedUserName;
                    document.getElementById('price-amount').textContent = `¥${namePriceMap[selectedUserName]}`;
                    await showCurrentUserWish();
                    goToStep(2);
                    return;
                }
                
                const name = document.getElementById('name').value.trim();
                if (!name) { 
                    alert('请输入姓名'); 
                    return; 
                }
                showConfirmModal(name);
            });
            
            // 姓名确认弹窗
            function showConfirmModal(name) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-primary/10 flex items-center justify-center">
                                <i class="fa fa-info-circle text-3xl text-primary"></i>
                            </div>
                            <h3 class="text-xl font-bold text-dark mb-2">请确认您的姓名</h3>
                            <p class="text-gray-600">${name}，心愿清单只能查询一个人的哦~确认后将无法更换！</p>
                        </div>
                        <div class="flex gap-4">
                            <button id="confirm-cancel" class="btn-3d bg-gray-200 text-gray-700 w-1/2">返回</button>
                            <button id="confirm-ok" class="btn-3d btn-3d-primary w-1/2">确认</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                document.getElementById('confirm-cancel').onclick = () => {
                    document.body.removeChild(modal);
                };
                
                document.getElementById('confirm-ok').onclick = async () => {
                    document.body.removeChild(modal);
                    await proceedToWishList(name);
                };
            }
            
            // 进入心愿填写页面
            async function proceedToWishList(name) {
                const cleanName = name.trim();
                const allowedNames = Object.keys(namePriceMap);
                
                let matchedName = allowedNames.find(k => 
                    k.trim().toLowerCase() === cleanName.toLowerCase()
                );
                
                if (!matchedName) {
                    alert(`姓名不在允许列表中！\n允许的姓名：${allowedNames.join('、')}`);
                    return;
                }
                
                selectedUserName = matchedName;
                localStorage.setItem('selectedUserName', matchedName);
                
                document.getElementById('back-to-step-1').disabled = false;
                document.getElementById('back-to-step-1').classList.remove('opacity-50', 'cursor-not-allowed');
                
                document.getElementById('price-amount').textContent = `¥${namePriceMap[matchedName]}`;
                
                await showCurrentUserWish();
                goToStep(2);
            }
            
            // 编辑心愿按钮逻辑
            document.getElementById('edit-wish-btn').addEventListener('click', function() {
                if (!canModifyWish()) {
                    alert(`已超过截止时间，无法修改心愿！\n截止时间：${(localStorage.getItem('wishDeadline') || DEFAULT_DEADLINE).replace('T', ' ')}`);
                    return;
                }
                
                isEditing = true;
                document.getElementById('wish').value = currentUserWish.content;
                document.getElementById('submit-btn-text').textContent = '保存修改';
                document.getElementById('existing-wish-card').classList.add('hidden');
            });
            
            // 提交/修改心愿主逻辑（整合云端同步）
            document.getElementById('submit-wish-btn').onclick = async function() {
                const wishContent = document.getElementById('wish').value.trim();
                const userName = selectedUserName || document.getElementById('name').value.trim();
                const userPrice = document.getElementById('price-amount').textContent;
                
                if (!wishContent) {
                    alert('请输入您的心愿内容！');
                    return;
                }
                if (!userName) {
                    alert('请先返回输入姓名！');
                    goToStep(1);
                    return;
                }
                
                if (!canModifyWish()) {
                    alert(`已超过截止时间，无法提交/修改心愿！\n截止时间：${(localStorage.getItem('wishDeadline') || DEFAULT_DEADLINE).replace('T', ' ')}`);
                    return;
                }
                
                const now = new Date();
                const timeString = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,0)}-${String(now.getDate()).padStart(2,0)} ${String(now.getHours()).padStart(2,0)}:${String(now.getMinutes()).padStart(2,0)}`;
                
                const wishData = {
                    name: userName,
                    content: wishContent,
                    price: userPrice,
                    time: timeString,
                    updated: isEditing,
                    createTime: now.getTime()
                };
                
                // 同步到GitHub Gist（免费跨设备核心）
                const cloudRes = await submitWishToCloud(wishData);
                
                // 更新本地数据
                const userWishIndex = submittedWishes.findIndex(w => 
                    w.name.trim().toLowerCase() === userName.trim().toLowerCase()
                );
                
                if (userWishIndex >= 0) {
                    submittedWishes[userWishIndex] = wishData;
                    alert(isEditing ? '您的心愿已修改成功！' + (cloudRes.success ? '（云端同步完成）' : '（仅本地保存）') : '您的心愿已更新！' + (cloudRes.success ? '（云端同步完成）' : '（仅本地保存）'));
                } else {
                    submittedWishes.push(wishData);
                    alert('您的心愿已提交成功！' + (cloudRes.success ? '（云端同步完成）' : '（仅本地保存）'));
                }
                safeSetStorage('submittedWishes', submittedWishes);
                
                // 更新成功页面显示
                document.getElementById('wish-card-name').textContent = userName;
                document.getElementById('wish-card-content').textContent = wishContent;
                document.getElementById('wish-card-price').textContent = userPrice;
                document.getElementById('wish-card-time').textContent = timeString;
                
                if (isEditing) {
                    document.getElementById('success-title').textContent = '心愿修改成功！';
                    document.getElementById('success-desc').textContent = '您的心愿已成功修改，让我们一起期待惊喜吧！';
                } else {
                    document.getElementById('success-title').textContent = '心愿提交成功！';
                    document.getElementById('success-desc').textContent = '您的心愿已成功提交，让我们一起期待惊喜吧！';
                }
                
                isEditing = false;
                document.getElementById('submit-btn-text').textContent = '提交心愿';
                goToStep(3);
            };
            
            // 管理员查看所有心愿（整合云端数据）
            document.getElementById('view-wishes-btn').addEventListener('click', async function() {
                const cloudRes = await getAllCloudWishes();
                let allWishes = [];
                
                if (cloudRes.success) {
                    allWishes = cloudRes.data;
                } else {
                    allWishes = submittedWishes;
                    alert('云端获取失败，显示本地数据：' + cloudRes.msg);
                }
                
                if (allWishes.length === 0) {
                    alert('暂无用户提交的心愿！');
                    return;
                }
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 backdrop-blur-sm';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl p-6 w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-dark">所有用户心愿（共${allWishes.length}条）</h3>
                            <button id="close-wishes-modal" class="text-gray-500 hover:text-gray-700 p-2">
                                <i class="fa fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="space-y-4" id="wishes-list-container">
                            ${allWishes.map((wish, index) => `
                                <div class="card-wish p-4">
                                    <div class="flex justify-between items-start mb-2">
                                        <h4 class="text-lg font-bold text-dark">${index+1}. ${wish.name || '未知姓名'}</h4>
                                        <span class="text-sm ${wish.updated ? 'text-orange-500' : 'text-green-500'}">
                                            ${wish.updated ? '已修改' : '首次提交'}
                                        </span>
                                    </div>
                                    <div class="bg-light rounded-lg p-3 mb-2">
                                        <p class="text-gray-700">${wish.content || '无内容'}</p>
                                    </div>
                                    <div class="flex justify-between text-sm text-gray-500">
                                        <span>价位: ${wish.price || '¥0'}</span>
                                        <span>提交时间: ${wish.time || '未知时间'}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-4 text-center">
                            <button id="export-wishes" class="btn-3d bg-blue-500 text-white px-4 py-2 rounded-lg">
                                <i class="fa fa-download mr-1"></i> 导出心愿列表（含价位）
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                document.getElementById('close-wishes-modal').onclick = () => {
                    document.body.removeChild(modal);
                };
                
                document.getElementById('export-wishes').onclick = () => {
                    const dataStr = JSON.stringify(allWishes, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `心愿列表_${new Date().toLocaleDateString()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    alert('心愿列表（含价位）已导出！');
                };
            });
            
            // 调试功能
            document.getElementById('debug-view-data').addEventListener('click', async function() {
                let cloudWishes = [];
                
                // 获取云端数据
                const cloudRes = await getAllCloudWishes();
                if (cloudRes.success) {
                    cloudWishes = cloudRes.data;
                }
                
                document.getElementById('debug-cloud-wish').textContent = JSON.stringify(cloudWishes, null, 2);
                document.getElementById('debug-local-wish').textContent = JSON.stringify(submittedWishes, null, 2);
                document.getElementById('debug-name-price').textContent = JSON.stringify(namePriceMap, null, 2);
                
                document.getElementById('debug-modal').classList.remove('hidden');
            });
            
            // 步骤切换逻辑（修复动画和显示问题）
            function goToStep(stepNumber) {
                steps.forEach(step => {
                    step.classList.add('hidden');
                    step.classList.remove('active');
                });
                const currentStep = document.getElementById(`step-${stepNumber}`);
                currentStep.classList.remove('hidden');
                currentStep.style.position = 'relative'; // 修复布局错位
                setTimeout(() => {
                    currentStep.classList.add('active');
                }, 10);
                
                stepIndicators.forEach((indicator, index) => {
                    const stepNum = index + 1;
                    const stepCircle = indicator.querySelector('div');
                    
                    if (stepNum < stepNumber) {
                        stepCircle.className = 'w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold mb-2';
                        stepCircle.innerHTML = '<i class="fa fa-check"></i>';
                    } else if (stepNum === stepNumber) {
                        stepCircle.className = 'w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold mb-2 step-active';
                        stepCircle.textContent = stepNum;
                    } else {
                        stepCircle.className = 'w-10 h-10 rounded-full bg-white/30 text-white flex items-center justify-center font-bold mb-2';
                        stepCircle.textContent = stepNum;
                    }
                });
            }
            
            // 管理员功能（原有逻辑保留）
            document.getElementById('admin-toggle').onclick = () => {
                const password = prompt('请输入管理员密码：');
                if (password === 'admin123') {
                    document.getElementById('admin-modal').classList.remove('hidden');
                    renderNameList();
                } else {
                    alert('密码错误！无法进入管理员模式');
                }
            };
            
            document.getElementById('close-admin-modal').onclick = () => {
                document.getElementById('admin-modal').classList.add('hidden');
            };
            
            function renderNameList() {
                const container = document.getElementById('name-list');
                container.innerHTML = '';
                
                Object.entries(namePriceMap).forEach(([name, price]) => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between bg-white/5 rounded-lg p-3 border border-white/10';
                    item.innerHTML = `
                        <div class="flex items-center">
                            <input type="text" value="${name}" class="bg-transparent border-none text-white focus:outline-none mr-4 name-input w-24" placeholder="姓名">
                            <span class="text-white/50">¥</span>
                            <input type="number" value="${price}" class="bg-transparent border-none text-white focus:outline-none w-16 price-input" placeholder="价格">
                        </div>
                        <button class="delete-name-btn text-white/30 hover:text-white transition-colors">
                            <i class="fa fa-trash"></i>
                        </button>
                    `;
                    
                    item.querySelector('.delete-name-btn').onclick = () => {
                        delete namePriceMap[name];
                        renderNameList();
                    };
                    
                    item.querySelector('.name-input').onchange = (e) => {
                        const newName = e.target.value.trim();
                        if (newName && newName !== name) {
                            delete namePriceMap[name];
                            namePriceMap[newName] = price;
                            renderNameList();
                        }
                    };
                    
                    item.querySelector('.price-input').onchange = (e) => {
                        namePriceMap[name] = parseInt(e.target.value) || 0;
                    };
                    
                    container.appendChild(item);
                });
            }
            
            document.getElementById('add-name-btn').onclick = () => {
                const newName = `新用户${Object.keys(namePriceMap).length + 1}`;
                namePriceMap[newName] = 200;
                renderNameList();
            };
            
            document.getElementById('reset-default-btn').onclick = () => {
                if (confirm('确定要恢复默认设置吗？')) {
                    namePriceMap = { ...DEFAULT_NAME_PRICE_MAP };
                    document.getElementById('deadline-input').value = DEFAULT_DEADLINE;
                    renderNameList();
                }
            };
            
            document.getElementById('save-settings-btn').onclick = () => {
                safeSetStorage('namePriceMap', namePriceMap);
                const deadline = document.getElementById('deadline-input').value;
                if (deadline) {
                    localStorage.setItem('wishDeadline', deadline);
                    document.getElementById('deadline-tip').textContent = `心愿修改截止时间：${deadline.replace('T', ' ')}`;
                }
                alert('设置已保存！');
                document.getElementById('admin-modal').classList.add('hidden');
            };
            
            // 调试弹窗功能
            document.getElementById('close-debug-modal').onclick = () => {
                document.getElementById('debug-modal').classList.add('hidden');
            };
            
            document.getElementById('clear-all-data').onclick = async () => {
                if (confirm('确定要清空所有存储数据吗？此操作不可恢复！')) {
                    localStorage.clear();
                    submittedWishes = [];
                    namePriceMap = { ...DEFAULT_NAME_PRICE_MAP };
                    selectedUserName = null;
                    currentUserWish = null;
                    
                    // 清空GitHub Gist数据
                    try {
                        const res = await fetch(GIST_API_URL, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `token ${GITHUB_TOKEN}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                files: {
                                    'wish-collection.json': {
                                        content: '[]'
                                    }
                                }
                            })
                        });
                        
                        if (res.ok) {
                            alert('本地+云端数据已清空！');
                        } else {
                            alert('本地数据已清空，云端数据清空失败！');
                        }
                    } catch (e) {
                        console.error('清空云端数据失败:', e);
                        alert('本地数据已清空，云端数据清空失败！');
                    }
                    
                    document.getElementById('debug-cloud-wish').textContent = '';
                    document.getElementById('debug-local-wish').textContent = JSON.stringify(submittedWishes, null, 2);
                    document.getElementById('debug-name-price').textContent = JSON.stringify(namePriceMap, null, 2);
                }
            };
            
            // 生成星星装饰
            function generateStars() {
                const container = document.getElementById('stars-container');
                const starCount = 50;
                
                for (let i = 0; i < starCount; i++) {
                    const star = document.createElement('div');
                    const size = Math.random() * 3 + 1;
                    const opacity = Math.random() * 0.8 + 0.2;
                    
                    star.className = 'absolute rounded-full bg-white animate-pulse-slow';
                    star.style.width = `${size}px`;
                    star.style.height = `${size}px`;
                    star.style.left = `${Math.random() * 100}%`;
                    star.style.top = `${Math.random() * 100}%`;
                    star.style.opacity = opacity;
                    star.style.animationDelay = `${Math.random() * 5}s`;
                    
                    container.appendChild(star);
                }
            }
            
            // 页面加载初始化
            window.onload = async function() {
                selectedUserName = localStorage.getItem('selectedUserName');
                
                if (selectedUserName) {
                    document.getElementById('name').value = selectedUserName;
                    document.getElementById('back-to-step-1').disabled = false;
                    document.getElementById('back-to-step-1').classList.remove('opacity-50', 'cursor-not-allowed');
                    await showCurrentUserWish();
                }
                
                const deadline = localStorage.getItem('wishDeadline') || DEFAULT_DEADLINE;
                document.getElementById('deadline-tip').textContent = `心愿修改截止时间：${deadline.replace('T', ' ')}`;
            };
        });
    </script>
</body>
</html>
